<div class="container mb-2">
    <mat-card class="example-card card" *ngIf="typeUser==2 || typeUser==1">
        <mat-card-header>
            <mat-card-title>Agregar inventario</mat-card-title>
        </mat-card-header>
        <mat-card-content>
            <div class="form-container">
                <form [formGroup]="invForm">
                    <div class="mx-auto" fxFlex="50%">
                        <mat-form-field
                            class="form-field-margin"
                            appearance="fill"
                        >
                            <mat-label>Nombre</mat-label>
                            <input matInput formControlName="nombre" required />
                        </mat-form-field>
                        <mat-form-field
                            class="form-field-margin ml-2 mr-2"
                            appearance="fill"
                        >
                            <mat-label>Descripcion</mat-label>
                            <input
                                matInput
                                formControlName="descripcion"
                                required
                            />
                        </mat-form-field>
                    </div>
                </form>
            </div>

            <div class="mb-2"></div>
            <table
                mat-table
                [dataSource]="dataSource"
                class="mat-elevation-z8 demo-table"
            >
                <!-- Position Column -->
                <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef>Cantidad</th>
                    <td mat-cell *matCellDef="let element;let i = index">
                        <div
                            *ngIf="!element.saved && element.producto=='init'"
                            class="example-button-container"
                        >
                            <button
                                class="btn btn-info mb-1"
                                mat-mini-fab
                                (click)="addRow(i)"
                                matTooltip="Agregar nuevo producto"
                            >
                                <mat-icon>add_circle</mat-icon>
                            </button>
                        </div>
                        <div
                            class="example-button-container"
                            *ngIf="element.saved && element.producto!=='init'"
                        >
                            <button
                                mat-mini-fab
                                class="btn btn-primary mb-1"
                                (click)="editRow(element,i)"
                                matTooltip="Editar la fila"
                            >
                                <mat-icon>edit</mat-icon>
                            </button>
                        </div>
                        <div
                            class="example-button-container"
                            *ngIf="element.saved && element.producto!=='init'"
                        >
                            <button
                                mat-mini-fab
                                class="btn btn-danger mb-1"
                                aria-label="Example icon button with a plus one icon"
                                (click)="deleteItem(i)"
                                matTooltip="Eliminar esta fila"
                            >
                                <mat-icon>delete</mat-icon>
                            </button>
                        </div>
                        <div
                            class="example-button-container"
                            *ngIf="!element.saved && element.producto!=='init'"
                        >
                            <button
                                (click)="savedRow(i,element )"
                                class="btn btn-success mb-1"
                                mat-mini-fab
                                matTooltip="Guardar la fila"
                            >
                                <mat-icon>save</mat-icon>
                            </button>
                        </div>
                        <div
                            class="example-button-container"
                            *ngIf="!element.saved && element.producto!=='init'"
                        >
                            <button
                                (click)="cancel(i,element )"
                                class="btn btn-danger mb-1"
                                mat-mini-fab
                                matTooltip="Cancelar esta fila"
                            >
                                <mat-icon>cancel</mat-icon>
                            </button>
                        </div>
                    </td>
                </ng-container>

                <!-- Name Column -->
                <form [formGroup]="prodForm">
                    <ng-container matColumnDef="cantidad">
                        <th mat-header-cell *matHeaderCellDef>Cantidad</th>
                        <td mat-cell *matCellDef="let element;let i = index">
                            <div
                                *ngIf="!element.saved && element.producto!=='init'"
                            >
                                <mat-form-field class="example-full-width">
                                    <mat-label>Cantidad</mat-label>
                                    <input
                                        formControlName="cantidad"
                                        (input)="changeCantidad($event.target,i)"
                                        matInput
                                        placeholder="1"
                                        value="1"
                                        type="number"
                                    />
                                </mat-form-field>
                            </div>
                            <p *ngIf="element.saved">{{element.cantidad}}</p>
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="producto">
                        <th mat-header-cell *matHeaderCellDef>Producto</th>
                        <td mat-cell *matCellDef="let element;let i = index;">
                            <div *ngIf="element.saved">
                                {{element.producto}}
                            </div>
                            <div
                                class="container"
                                *ngIf="!element.saved && element.producto!=='init'"
                            >
                                <mat-form-field class="form-field-margin">
                                    <!-- <mat-label>producto</mat-label> -->
                                    <mat-select formControlName="producto">
                                        @for (pte of prods; track pte) {
                                        <mat-option
                                            (onSelectionChange)="changeProducto($event,i)"
                                            [value]="pte"
                                            >{{pte.nombre}}</mat-option
                                        >
                                        }
                                    </mat-select>
                                </mat-form-field>
                            </div>
                        </td>
                    </ng-container>
                </form>
                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr
                    mat-row
                    *matRowDef="let row; columns: displayedColumns;"
                ></tr>
            </table>

            <mat-card-actions>
                <button
                    mat-raised-button
                    color="primary"
                    (click)="saveInventario()"
                    matTooltip="Guardar el inventario"
                >
                    <mat-icon>save</mat-icon> Guardar
                </button>
            </mat-card-actions>
        </mat-card-content>
    </mat-card>
</div>

<div class="container">
    <mat-card>
        <table
            mat-table
            [dataSource]="dataSourceInventarios"
            class="mat-elevation-z8 demo-table"
            multiTemplateDataRows
        >
            <ng-container matColumnDef="expand">
                <th mat-header-cell *matHeaderCellDef aria-label="row actions">
                    &nbsp;
                </th>
                <td mat-cell *matCellDef="let element;let i=index">
                    <button
                        mat-icon-button
                        aria-label="expand row"
                        (click)="show(element,i); $event.stopPropagation()"
                        matTooltip="Detalle de inventario"
                    >
                        @if (expandedElement === element) {
                        <mat-icon>keyboard_arrow_up</mat-icon>
                        } @else {
                        <mat-icon>keyboard_arrow_down</mat-icon>
                        }
                    </button>
                </td>
            </ng-container>
            <ng-container matColumnDef="expandedDetail">
                <td
                    mat-cell
                    *matCellDef="let element"
                    [attr.colspan]="columnsToDisplayWithExpand.length"
                >
                    <div
                        class="example-element-detail"
                        [@detailExpand]="element == expandedElement ? 'expanded' : 'collapsed'"
                    ></div>
                    <table
                        mat-table
                        [dataSource]="dataSourceInventariosDetalle"
                        class="mat-elevation-z8 demo-table mb-2 mt-2"
                        *ngIf="element['show']"
                    >
                        <ng-container matColumnDef="producto">
                            <th mat-header-cell *matHeaderCellDef>Producto</th>
                            <td
                                mat-cell
                                *matCellDef="let element2;let i = index"
                            >
                                {{element2['productoId']['nombre']}}
                            </td>
                        </ng-container>
                        <ng-container matColumnDef="cantidad">
                            <th mat-header-cell *matHeaderCellDef>Cantidad</th>
                            <td
                                mat-cell
                                *matCellDef="let element2;let i = index"
                            >
                                {{element2['stock']['$numberDecimal']}}
                            </td>
                        </ng-container>
                        <tr
                            mat-header-row
                            *matHeaderRowDef="displayedColumnsDetalle"
                        ></tr>
                        <tr
                            mat-row
                            *matRowDef="let row; columns: displayedColumnsDetalle;"
                        ></tr>
                    </table>
                </td>
            </ng-container>
            <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>Acciones</th>
                <td mat-cell *matCellDef="let element;let i = dataIndex;">
                    <div class="example-button-container">
                        <button
                            mat-mini-fab
                            class="btn btn-primary mb-1 mr-1"
                            (click)="editInventario(element)"
                            matTooltip="Editar el inventario"
                        >
                            <mat-icon>edit</mat-icon>
                        </button>
                    </div>
                    <div class="example-button-container">
                        <button
                            mat-mini-fab
                            class="btn btn-danger mb-1 mr-1"
                            (click)="deleteInventario(element,i)"
                            matTooltip="Eliminar el inventario"
                            [disabled]="element['disabled']"
                        >
                            <mat-icon>delete</mat-icon>
                        </button>
                    </div>
                </td>
            </ng-container>
            <ng-container matColumnDef="nombre">
                <th mat-header-cell *matHeaderCellDef>Nombre</th>
                <td mat-cell *matCellDef="let element;let i = index">
                    {{element['header']['nombre']}}
                </td>
            </ng-container>
            <ng-container matColumnDef="descripcion">
                <th mat-header-cell *matHeaderCellDef>Descripcion</th>
                <th></th>
                <td mat-cell *matCellDef="let element;let i = index">
                    {{element['header']['descripcion']}}
                </td>
            </ng-container>
            <ng-container matColumnDef="creadopor">
                <th mat-header-cell *matHeaderCellDef>Creado por</th>
                <td mat-cell *matCellDef="let element;let i = index">
                    {{element['header']['idUsuario']['nombre']}}
                </td>
            </ng-container>
            <ng-container matColumnDef="fecha">
                <th mat-header-cell *matHeaderCellDef>Fecha</th>
                <td mat-cell *matCellDef="let element;let i = index">
                    {{element['header']['fecha'] | date}}
                </td>
            </ng-container>
            <tr
                mat-header-row
                *matHeaderRowDef="columnsToDisplayWithExpand"
            ></tr>
            <tr
                mat-row
                *matRowDef="let element; columns: columnsToDisplayWithExpand;"
                class="example-element-row"
                [class.example-expanded-row]="expandedElement === element"
                (click)="expandedElement = expandedElement === element ? null : element"
            ></tr>
            <tr
                mat-row
                *matRowDef="let row; columns: ['expandedDetail']"
                class="example-detail-row"
            ></tr>
        </table>
    </mat-card>
</div>
